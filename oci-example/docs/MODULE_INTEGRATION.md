# Module Integration Guide

This document identifies which files are auto-generated from modules and which need manual updates when adding new applications/modules.

## Auto-Generated Files

### 1. `terraform.tfvars`
- **Source**: Concatenated from `{infra_*,app*}*.tfvars` files
- **Generator**: `generate_terraform_tfvars.sh`
- **Pattern**: `cat {infra_*,app*}*.tfvars > terraform.tfvars`
- **Update Required**: âŒ NO - Automatically picks up new `app*_terraform.tfvars` files via glob pattern

### 2. `terraform_fqrn.tf` âœ… **AUTO-GENERATED**
- **Source**: Module references from `infra_main.tf` and `app*_main.tf` files
- **Generator**: `generate_all_fqrn.sh` (uses Python venv + Jinja2 template)
- **Template**: `templates/terraform_fqrn.tf.j2`
- **Update Required**: âŒ NO - Run `./bin/generate_all_fqrn.sh` after adding new apps/modules
- **Dependencies**: Python 3, jinja2 (auto-installed in `.venv/`)
- **Note**: File is auto-generated (like `terraform.tfvars`) - DO NOT EDIT MANUALLY

## Files Requiring Manual Updates

### 1. `terraform_fqrn.tf` âš ï¸ **MANUAL UPDATE** (only if not using auto-generation)

When adding a new application (e.g., APP3), you must manually update `terraform_fqrn.tf`:

**Add new app FQRN maps:**
```hcl
# APP3 module FQRN maps
app3_nsg_fqrns = merge([
  for k, m in module.app3_nsgs : m.fqrn_map
]...)

app3_compute_instance_fqrns = merge([
  for k, m in module.app3_compute_instances : m.fqrn_map
]...)
```

**Update `network_fqrns` to include new app NSGs:**
```hcl
network_fqrns = merge(
  local.network_fqrns_base,
  local.app1_nsg_fqrns,
  local.app2_nsg_fqrns,
  local.app3_nsg_fqrns   # â† ADD THIS
)
```

**Update unified `fqrns` map:**
```hcl
fqrns = merge(
  local.compartment_fqrns,
  local.vcn_fqrns,
  local.subnet_fqrns,
  local.app1_nsg_fqrns,
  local.app1_compute_instance_fqrns,
  local.app2_nsg_fqrns,
  local.app2_compute_instance_fqrns,
  local.app3_nsg_fqrns,              # â† ADD THIS
  local.app3_compute_instance_fqrns  # â† ADD THIS
)
```

### 2. `infra_outputs.tf`
- **Update Required**: âŒ NO - Only contains infrastructure outputs (compartments, VCNs, subnets)
- **Note**: App-specific outputs go in `app*_outputs.tf` files

### 3. `infra_main.tf`
- **Update Required**: âŒ NO - Only contains infrastructure (compartments, VCNs, subnets)
- **Note**: App-specific modules go in `app*_main.tf` files

### 4. `infra_locals.tf`
- **Update Required**: âŒ NO - Only contains infrastructure locals (tenancy, region, availability domains)

### 5. `infra_variables.tf`
- **Update Required**: âŒ NO - Only contains infrastructure variable definitions

## New Files Required Per Application

When adding a new application (e.g., APP3), create these new files:

### 1. `app3_main.tf`
- **Purpose**: APP3-specific module calls (NSGs, compute instances)
- **Pattern**: Copy from `app1_main.tf` or `app2_main.tf` and adapt
- **Example**:
```hcl
module "app3_nsgs" {
  source   = "./modules/nsg"
  for_each = var.app3_nsgs
  # ...
}

module "app3_compute_instances" {
  source   = "./modules/compute_instance"
  for_each = var.app3_compute_instances
  # ...
}
```

### 2. `app3_variables.tf`
- **Purpose**: APP3 variable definitions
- **Pattern**: Copy from `app1_variables.tf` and adapt
- **Variables**: `app3_zones`, `app3_nsgs`, `app3_compute_instances`

### 3. `app3_terraform.tfvars`
- **Purpose**: APP3 configuration values
- **Pattern**: Copy from `app1_terraform.tfvars` and adapt
- **Auto-included**: âœ… YES - Automatically picked up by `generate_terraform_tfvars.sh`

### 4. `app3_outputs.tf`
- **Purpose**: APP3-specific outputs
- **Pattern**: Copy from `app1_outputs.tf` and adapt
- **Example**:
```hcl
output "app3_nsgs" {
  value = { for k, m in module.app3_nsgs : k => { ... } }
}

output "app3_compute_instances" {
  value = { for k, m in module.app3_compute_instances : k => { ... } }
}
```

## Summary: Adding a New Application (APP3)

### âœ… Automatic (No Manual Update):
1. `terraform.tfvars` - Auto-generated from `app3_terraform.tfvars` via glob pattern
2. `terraform_fqrn.tf` - Auto-generated by running `./bin/generate_all_fqrn.sh`
3. `generate_terraform_tfvars.sh` - No changes needed (uses glob pattern)
4. `generate_all_fqrn.sh` - No changes needed (auto-detects new apps)

### âš ï¸ Manual Updates Required:
1. None! Just run the generation scripts after creating new app files.

### ğŸ“ New Files to Create:
1. `app3_main.tf` - APP3 module calls
2. `app3_variables.tf` - APP3 variable definitions
3. `app3_terraform.tfvars` - APP3 configuration
4. `app3_outputs.tf` - APP3 outputs

## Quick Reference Checklist

When adding APP3:

- [ ] Create `app3_main.tf` (copy from `app1_main.tf`)
- [ ] Create `app3_variables.tf` (copy from `app1_variables.tf`)
- [ ] Create `app3_terraform.tfvars` (copy from `app1_terraform.tfvars`)
- [ ] Create `app3_outputs.tf` (copy from `app1_outputs.tf`)
- [ ] **Run `./bin/generate.sh`** to auto-generate all files (includes APP3 automatically)
- [ ] Run `terraform validate` to verify

