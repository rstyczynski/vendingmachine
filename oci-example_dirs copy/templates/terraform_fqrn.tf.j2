# ═══════════════════════════════════════════════════════════════
# Unified FQRN Map Aggregation
# Aggregates FQRN maps from all applications and shared resources
# ═══════════════════════════════════════════════════════════════
#
# AUTO-GENERATED - DO NOT EDIT MANUALLY
# This file is auto-generated (similar to terraform.tfvars)
# Generated by: bin/generate_fqrn.sh
# Template: templates/terraform_fqrn.tf.j2
#

locals {
  # Shared infrastructure FQRN maps
{%- for mod in shared_modules %}
  {{ mod.var_name }} = {% if mod.for_each %}merge([
    for k, m in module.{{ mod.name }} : m.fqrn_map
  ]...){% else %}module.{{ mod.name }}.fqrn_map{% endif %}

{%- endfor %}
{%- for app_name, modules in apps.items() %}
  # {{ app_name.upper() }} module FQRN maps
{%- for mod in modules %}
  {{ mod.name }}_fqrns = merge([
    for k, m in module.{{ mod.name }} : m.fqrn_map
  ]...)

{%- endfor %}
{%- endfor %}

  # ═══════════════════════════════════════════════════════════════
  # Combined FQRN maps for layer dependencies (dynamically built)
  # ═══════════════════════════════════════════════════════════════

{%- set compartment_mod = shared_modules | selectattr("name", "equalto", "compartments") | first %}
{%- set vcn_mod = shared_modules | selectattr("name", "equalto", "vcns") | first %}
{%- set subnet_mod = shared_modules | selectattr("name", "equalto", "subnets") | first %}
{%- set bastion_mod = shared_modules | selectattr("name", "equalto", "bastions") | first %}

{%- if compartment_mod and vcn_mod %}
  # Layer 1+2: Compartments and VCNs
  compartment_and_vcn_fqrns = merge(
    local.{{ compartment_mod.var_name }},
    local.{{ vcn_mod.var_name }}
  )
{%- endif %}

{%- if compartment_mod and vcn_mod and subnet_mod %}
  # Layer 1+2+3: Compartments, VCNs, and Subnets
  compartment_vcn_subnet_fqrns = merge(
    local.{{ compartment_mod.var_name }},
    local.{{ vcn_mod.var_name }},
    local.{{ subnet_mod.var_name }}
  )
{%- endif %}

  # Network FQRNs base (without app NSGs to avoid cycles during NSG creation)
{%- if compartment_mod and vcn_mod and subnet_mod %}
  network_fqrns_base = merge(
    local.{{ compartment_mod.var_name }},
    local.{{ vcn_mod.var_name }},
    local.{{ subnet_mod.var_name }}
  )
{%- endif %}

  # Network FQRNs including all NSGs (for use after NSGs are created)
{%- if compartment_mod and vcn_mod and subnet_mod %}
  network_fqrns = merge(
    local.network_fqrns_base,
{%- for app_name, modules in apps.items() %}
{%- for mod in modules %}
{%- if 'nsgs' in mod.name %}
    local.{{ mod.name }}_fqrns,  # Include {{ app_name.upper() }} NSGs
{%- endif %}
{%- endfor %}
{%- endfor %}
  )
{%- endif %}

  # Infrastructure FQRNs (network + bastions, for use by zones)
  infra_fqrns = merge(
{%- if compartment_mod %}
    local.{{ compartment_mod.var_name }},
{%- endif %}
{%- if vcn_mod %}
    local.{{ vcn_mod.var_name }},
{%- endif %}
{%- if subnet_mod %}
    local.{{ subnet_mod.var_name }},
{%- endif %}
{%- if bastion_mod %}
    local.{{ bastion_mod.var_name }},
{%- endif %}
{%- for app_name, modules in apps.items() %}
{%- for mod in modules %}
{%- if 'nsgs' in mod.name %}
    local.{{ mod.name }}_fqrns,
{%- endif %}
{%- endfor %}
{%- endfor %}
  )

  # Unified FQRN map - merges ALL resources from all applications
  fqrns = merge(
{%- for mod in shared_modules %}
    local.{{ mod.var_name }},
{%- endfor %}
{%- for app_name, modules in apps.items() %}
{%- for mod in modules %}
    local.{{ mod.name }}_fqrns,
{%- endfor %}
{%- endfor %}
  )

  # Unified FQRN map for output (alias)
  unified_fqrn_map = local.fqrns
}
